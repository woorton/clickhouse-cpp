name: Windows

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  CONAN_USER_HOME: "${{ github.workspace }}/conan/"
  CONAN_USER_HOME_SHORT: "${{ github.workspace }}/conan/short"

  BUILD_TYPE: Release
  GTEST_FILTER: --gtest_filter=-"*"
  CLICKHOUSE_USER: clickhouse_cpp_cicd
  CLICKHOUSE_PASSWORD: clickhouse_cpp_cicd
  #
  # CLICKHOUSE_HOST: localhost
  # CLICKHOUSE_PORT: 9000
  # CLICKHOUSE_USER: default
  # CLICKHOUSE_PASSWORD:
  # CLICKHOUSE_DB:   default
  #
  # CLICKHOUSE_SECURE_HOST:     github.demo.trial.altinity.cloud
  # CLICKHOUSE_SECURE_PORT:     9440
  # CLICKHOUSE_SECURE_USER:     demo
  # CLICKHOUSE_SECURE_PASSWORD: demo
  # CLICKHOUSE_SECURE_DB:       default
  #
  # CLICKHOUSE_SECURE2_HOST:    gh-api.clickhouse.tech
  # CLICKHOUSE_SECURE2_PORT:    9440
  # CLICKHOUSE_SECURE2_USER:    explorer
  # CLICKHOUSE_SECURE2_PASSWORD:
  # CLICKHOUSE_SECURE2_DB:      default

jobs:
  build:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        ssl: [ssl_ON, ssl_OFF]
        dependencies: [dependencies_SYSTEM, dependencies_BUILT_IN]
        include:
        - ssl: ssl_ON
          SSL_CONAN_OPTION: -o with_ssl=True

        - ssl: ssl_OFF
          SSL_CONAN_OPTION: -o with_ssl=False

        - dependencies: dependencies_SYSTEM
          DEPENDENCIES_CONAN_OPTIONS: >
            -o with_system_lz4=True
            -o with_system_cityhash=True
            -o with_system_abseil=True

        - dependencies: dependencies_BUILT_IN
          DEPENDENCIES_CONAN_OPTIONS: >
            -o with_system_lz4=False
            -o with_system_cityhash=False
            -o with_system_abseil=False

    steps:
    - uses: actions/checkout@v2
    - uses: ilammy/msvc-dev-cmd@v1

    - uses: turtlebrowser/get-conan@main

    - uses: actions/cache@v3.0.2
      with:
        key: host-${{ runner.os }}-target-${{ runner.os }}-${{ hashFiles('conanfile.py') }}
        path: ${{env.CONAN_USER_HOME}}

    - name: Configure & Build project
      run: |
        mkdir -p ${{github.workspace}}/build && cd ${{github.workspace}}/build

        conan install \
          -o build_tests=True \
          ${{matrix.SSL_CONAN_OPTION}} \
          ${{matrix.DEPENDENCIES_CONAN_OPTIONS}} \
          -s build_type=${{env.BUILD_TYPE}} \
          -b missing \
          ${{github.workspace}}

        conan build ${{github.workspace}}

    - name: Start tls offoader proxy
      shell: bash
      # that mimics non-secure clickhouse running on localhost
      # by tunneling queries to remote tls server
      # (needed because we can't start real clickhouse instance on windows)
      run: |
            choco install wget
            wget https://github.com/filimonov/go-tlsoffloader/releases/download/v0.1.2/go-tlsoffloader_0.1.2_Windows_x86_64.tar.gz
            tar -xvzf go-tlsoffloader_0.1.2_Windows_x86_64.tar.gz
            ./go-tlsoffloader.exe -l localhost:9000 -b github.demo.trial.altinity.cloud:9440 &

    - name: Test
      working-directory: ${{github.workspace}}/build/bin
      run: Release\clickhouse-cpp-ut.exe "${{env.GTEST_FILTER}}"
